<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Portland Hacker Foundation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/js/foundation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <style>
        #chat-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }
        #message-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .user-message {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
        }
        .ai-message {
            background-color: #f1f8e9;
            border-left: 4px solid #8bc34a;
        }
        .thinking {
            color: #666;
            font-style: italic;
        }
        #user-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .button-container {
            display: flex;
            justify-content: space-between;
        }
        .code-block {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 10px;
            margin: 10px 0;
            position: relative;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .copy-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 12px;
            cursor: pointer;
        }
        .copy-button:hover {
            background-color: #f0f0f0;
        }
        .thoughts-container {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff8e1;
            border-left: 4px solid #ffc107;
            display: none;
        }
        .thoughts-toggle {
            color: #2196F3;
            cursor: pointer;
            text-decoration: underline;
            font-size: 12px;
        }
    </style>
</head>
<body>
<div class='contain-to-grid sticky'>
  <nav class='top-bar' data-options='sticky_on: large' data-topbar=''>
    <ul class='title-area'>
      <li class='name'>
        <h1>
          <a href='index.html'>
            <img alt="Portland Hacker Foundation" src="favicon.ico" width="32" height="32" />
            Portland Hacker Foundation
          </a>
        </h1>
      </li>
      <li class='toggle-topbar menu-icon'>
        <a href='#'>Menu</a>
      </li>
    </ul>
    <section class='top-bar-section'>
      <ul class="right">
        <li class="">
          <a href="index.html">Home</a>
        </li>
        <li class="active">
          <a href="chat.html">Chat</a>
        </li>
        <li class="">
          <a href="https://docs.google.com/forms/d/e/1FAIpQLSfaRK_Q_D808wyhj5cFVxF1wO9nUbItCgGJQuCJyHfUzVUVjw/viewform">Apply for a Grant</a>
        </li>
        <li class="">
          <a href="https://www.paypal.com/donate/?hosted_button_id=GP42Y6XNS8ZTA">Become a Sponsor</a>
        </li>
        <li class="">
          <a href="https://signal.group/#CjQKICe1IhiChi74GgLGJql1-YcUndkMvRtniTkAygWVlaSWEhAXFtsQRFJPPxtXyodsPbou">Join Signal Chat</a>
        </li>
      </ul>
    </section>
  </nav>
</div>

<div id="chat-container">
    <h2>Chat with Portland Hacker Foundation AI</h2>
    <p>Ask questions about hackerspaces, grants, or how to get involved with the Portland hacker community.</p>
    
    <div id="message-container"></div>
    
    <textarea id="user-input" placeholder="Type your message here..." rows="3"></textarea>
    
    <div class="button-container">
        <button id="send-button" class="button success">Send Message</button>
        <button id="reset-button" class="button secondary">Reset Conversation</button>
    </div>
</div>

<div id='footer'>
  <div class='three spacing'></div>
  <div class='row'>
    <div class='large-3 medium-3 columns'>
      <h1>
        <a href='index.html'>
          <img alt="Portland Hacker Foundation" src="favicon.ico" width="32" height="32" />
        </a>
      </h1>
      <p>Â©2025 Portland Hacker Foundation</p>
      <div class='spacing'></div>
      <div class='spacing'></div>
    </div>
    <div class='large-3 medium-3 columns'>
      <div class='spacing'></div>
      <div class='links'>
        <h4>Common Pages</h4>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="chat.html">Chat</a></li>
          <li><a href="https://docs.google.com/forms/d/e/1FAIpQLSfaRK_Q_D808wyhj5cFVxF1wO9nUbItCgGJQuCJyHfUzVUVjw/viewform">Apply for a Grant</a></li>
          <li><a href="https://www.paypal.com/donate/?hosted_button_id=GP42Y6XNS8ZTA">Become a Sponsor</a></li>
        </ul>
      </div>
      <div class='spacing'></div>
    </div>
    <div class='large-3 medium-3 columns'>
      <div class='spacing'></div>
      <div class='links'>
        <h4>Recommended Links</h4>
        <ul>
          <li><a target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Hackerspace">Hackerspaces</a></li>
          <li><a target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Hacker_ethic">Hacker Ethic</a></li>
          <li><a target="_blank" rel="noopener noreferrer" href="https://wiki.hackerspaces.org/Design_Patterns">Design Patterns</a></li>
        </ul>
      </div>
      <div class='spacing'></div>
    </div>
    <div class='large-3 medium-3 columns'>
      <div class='spacing'></div>
      <h4>Contact Information</h4>
      <ul>
        <li>Email: info@pdxhf.org</li>
        <li>Location: Portland, OR USA</li>
      </ul>
      <div class='spacing'></div>
      <ul class='socials'>
        <li>
          <a target="_blank" rel="noopener noreferrer" href='#'>
            <i class='fa fa-twitter'></i>
          </a>
        </li>
        <li>
          <a target="_blank" rel="noopener noreferrer" href='#'>
            <i class='fa fa-facebook'></i>
          </a>
        </li>
      </ul>
      <div class='spacing'></div>
    </div>
  </div>
  <div class='two spacing'></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageContainer = document.getElementById('message-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const resetButton = document.getElementById('reset-button');
        
        let conversationId = null;
        
        // Function to add a message to the chat
        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'message user-message' : 'message ai-message';
            messageDiv.innerHTML = isUser ? content : DOMPurify.sanitize(marked.parse(content));
            
            // Add copy buttons to code blocks
            const codeBlocks = messageDiv.querySelectorAll('pre code');
            codeBlocks.forEach(block => {
                const pre = block.parentNode;
                pre.classList.add('code-block');
                
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = 'Copy';
                copyButton.addEventListener('click', function() {
                    navigator.clipboard.writeText(block.textContent);
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => {
                        copyButton.textContent = 'Copy';
                    }, 2000);
                });
                
                pre.appendChild(copyButton);
            });
            
            messageContainer.appendChild(messageDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
        
        // Function to add thinking animation
        function addThinking() {
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message ai-message thinking';
            thinkingDiv.id = 'thinking';
            thinkingDiv.textContent = 'Thinking';
            
            const dots = document.createElement('span');
            dots.id = 'thinking-dots';
            dots.textContent = '...';
            thinkingDiv.appendChild(dots);
            
            messageContainer.appendChild(thinkingDiv);
            messageContainer.scrollTop = messageContainer.scrollHeight;
            
            // Animate the dots
            let count = 0;
            const thinkingInterval = setInterval(() => {
                const dotsSpan = document.getElementById('thinking-dots');
                if (dotsSpan) {
                    count = (count + 1) % 4;
                    dotsSpan.textContent = '.'.repeat(count + 1);
                } else {
                    clearInterval(thinkingInterval);
                }
            }, 500);
            
            return thinkingInterval;
        }
        
        // Function to remove thinking animation
        function removeThinking(interval) {
            clearInterval(interval);
            const thinkingDiv = document.getElementById('thinking');
            if (thinkingDiv) {
                thinkingDiv.remove();
            }
        }
        
        // Function to add AI thoughts
        function addThoughts(thoughts, messageDiv) {
            if (!thoughts || thoughts.trim() === '') return;
            
            const thoughtsToggle = document.createElement('div');
            thoughtsToggle.className = 'thoughts-toggle';
            thoughtsToggle.textContent = 'Show AI thoughts';
            
            const thoughtsContainer = document.createElement('div');
            thoughtsContainer.className = 'thoughts-container';
            thoughtsContainer.innerHTML = DOMPurify.sanitize(marked.parse(thoughts));
            
            thoughtsToggle.addEventListener('click', function() {
                if (thoughtsContainer.style.display === 'block') {
                    thoughtsContainer.style.display = 'none';
                    thoughtsToggle.textContent = 'Show AI thoughts';
                } else {
                    thoughtsContainer.style.display = 'block';
                    thoughtsToggle.textContent = 'Hide AI thoughts';
                }
            });
            
            messageDiv.appendChild(thoughtsToggle);
            messageDiv.appendChild(thoughtsContainer);
        }
        
        // Function to send a message to the AI
        async function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;
            
            // Add user message to chat
            addMessage(message, true);
            userInput.value = '';
            
            // Add thinking animation
            const thinkingInterval = addThinking();
            
            try {
                // Send message to backend
                const response = await fetch('https://venice-backend-14aff752beac.herokuapp.com/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_id: conversationId,
                    }),
                    credentials: 'include',
                });
                
                if (!response.ok) {
                    throw new Error('Failed to get response from server');
                }
                
                // Get the conversation ID from the response
                const data = await response.json();
                conversationId = data.conversation_id;
                
                // Remove thinking animation
                removeThinking(thinkingInterval);
                
                // Add AI response to chat
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'message ai-message';
                messageContainer.appendChild(aiMessageDiv);
                
                // Add thoughts if available
                if (data.thoughts) {
                    addThoughts(data.thoughts, aiMessageDiv);
                }
                
                // Parse and display the AI response with markdown
                aiMessageDiv.innerHTML += DOMPurify.sanitize(marked.parse(data.response));
                
                // Add copy buttons to code blocks
                const codeBlocks = aiMessageDiv.querySelectorAll('pre code');
                codeBlocks.forEach(block => {
                    const pre = block.parentNode;
                    pre.classList.add('code-block');
                    
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-button';
                    copyButton.textContent = 'Copy';
                    copyButton.addEventListener('click', function() {
                        navigator.clipboard.writeText(block.textContent);
                        copyButton.textContent = 'Copied!';
                        setTimeout(() => {
                            copyButton.textContent = 'Copy';
                        }, 2000);
                    });
                    
                    pre.appendChild(copyButton);
                });
                
                messageContainer.scrollTop = messageContainer.scrollHeight;
            } catch (error) {
                console.error('Error:', error);
                removeThinking(thinkingInterval);
                addMessage('Sorry, there was an error processing your request. Please try again later.');
            }
        }
        
        // Function to reset the conversation
        async function resetConversation() {
            try {
                // Send reset request to backend
                const response = await fetch('https://venice-backend-14aff752beac.herokuapp.com/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                });
                
                if (!response.ok) {
                    throw new Error('Failed to reset conversation');
                }
                
                // Clear the conversation ID and message container
                conversationId = null;
                messageContainer.innerHTML = '';
                
                // Add a system message
                addMessage('Conversation has been reset. You can start a new chat now.');
            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, there was an error resetting the conversation. Please try again later.');
            }
        }
        
        // Event listeners
        sendButton.addEventListener('click', sendMessage);
        
        userInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        resetButton.addEventListener('click', resetConversation);
        
        // Initialize with a welcome message
        addMessage('Welcome to the Portland Hacker Foundation chat! How can I help you today?');
    });
    
    $(document).foundation();
</script>
</body>
</html>
